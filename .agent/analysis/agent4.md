# Platform Admin Auth/Permissions Investigation

## Current Flow

### Studio UI
- The Studio auth context is backed by the shared `AuthClient`, which is configured to talk to the GoTrue service using platform-specific environment variables. The client persists the current session locally and exposes helpers such as `getAccessToken()` for downstream callers.【F:packages/common/gotrue.ts†L1-L129】【F:packages/common/auth.tsx†L18-L185】
- Server and client fetch helpers attach the bearer token to every platform request. `constructHeaders()` injects the `Authorization` header before proxying requests through the OpenAPI client, so every call to `/platform/**` carries the GoTrue JWT.【F:apps/studio/data/fetchers.ts†L1-L135】
- The profile provider immediately queries `/platform/profile` after sign-in. If that call reports "profile not found", Studio falls back to `POST /platform/profile` to create the record and then refetches permissions and organizations; those flows assume the API understands the caller’s identity.【F:apps/studio/lib/profile.tsx†L33-L119】【F:apps/studio/data/profile/profile-create-mutation.ts†L1-L47】
- Feature gating relies on `useAsyncCheckPermissions`, which evaluates the permissions returned by `/platform/profile/permissions` against the active organization/project. Until the permissions arrive, most pages remain blocked (hence the "You need additional permissions" banner in table editor layouts).【F:apps/studio/hooks/misc/useCheckPermissions.ts†L137-L190】【F:apps/studio/components/layouts/TableEditorLayout/TableEditorLayout.tsx†L1-L25】

### API Gateway (Kong)
- In the platform docker compose profile, Studio is pointed at `http://host.docker.internal:8000` for all Supabase services. Kong terminates those requests, applies key-auth for the built-in APIs, and forwards `/api/platform/**` and `/api/v1/**` straight to the platform API container with only a CORS plugin attached.【F:docker/docker-compose.platform.yml†L1-L103】【F:docker/volumes/api/kong.platform.yml†L1-L17】
- The standard Kong declarative config still protects `/auth/v1`, `/rest/v1`, etc. with API key authentication and ACLs, so the GoTrue and PostgREST hops behave the same as a cloud stack once the headers are set by Studio.【F:docker/volumes/api/kong.yml†L1-L120】

### Platform API
- The Fastify server applies migrations, seeds defaults, and then registers the `api/v1` and `api/platform` routers without any authentication hooks. Every route trusts whichever headers arrive from Kong.【F:apps/platform-api/src/main.ts†L1-L53】【F:apps/platform-api/src/routes/platform.ts†L1-L35】
- Profile lookups simply read the first row from `platform.profiles` and return it, while the permissions endpoint emits a wildcard grant for every organization row. No JWT inspection happens, so all callers receive the same profile and full permissions regardless of their token.【F:apps/platform-api/src/store/profile.ts†L1-L20】【F:apps/platform-api/src/store/permissions.ts†L1-L35】
- Organization membership queries join `platform.organization_members` to `platform.profiles` on `profile_id`, and the fallback entry uses the seed’s `baseProfile`. Because `listOrganizations` also binds the current profile id to queries, every request today is resolved against the bootstrap record.【F:apps/platform-api/src/store/organization-members.ts†L1-L60】【F:apps/platform-api/src/store/organizations.ts†L1-L105】
- There is no implementation for creating profiles or mutating organization members, even though the Studio client calls `POST /platform/profile` and various `/platform/organizations/{slug}/members/{gotrue_id}` mutations when users self-serve admin changes.【F:apps/platform-api/src/routes/profile.ts†L1-L92】【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L1-L79】

### GoTrue and PostgREST
- Studio validates JWTs server-side through `apiAuthenticate`, which unwraps the bearer token to fetch GoTrue claims. On the client, fetchers forward the token and rely on Kong’s key-auth enforcement for GoTrue and PostgREST access.【F:apps/studio/lib/api/apiAuthenticate.ts†L1-L51】【F:apps/studio/data/fetchers.ts†L49-L135】
- The platform API forwards sign-up requests directly to GoTrue’s admin endpoint using the service key but never records the returned user id in `platform.profiles`. Subsequent password updates are also handled through the GoTrue admin API.【F:apps/platform-api/src/routes/auth.ts†L1-L128】

### Postgres
- The platform schema is created by the platform API migrations. It defines `platform.profiles`, `platform.organization_members`, and related tables with foreign keys but no row-level security or ownership policies, so all enforcement is expected to happen in the platform API layer.【F:apps/platform-api/migrations/0001_initial.sql†L61-L160】
- The API connects using `PLATFORM_DB_URL`/`SUPABASE_DB_URL` and issues direct SQL queries through Kysely; there is no per-request scoping to the caller’s `sub` claim.【F:apps/platform-api/src/db/client.ts†L1-L80】

## Source of Truth for User Linking
- Seed configuration defines a `baseProfile` with a randomly generated `gotrue_id` every time the process starts. That value is inserted into `platform.profiles` the first time the database is empty.【F:apps/platform-api/src/config/defaults.ts†L196-L209】【F:apps/platform-api/src/db/seed.ts†L80-L105】
- Organization memberships and all default organizations are seeded against the static profile id (`1`), and the fallback `listOrganizationMembers` response also mirrors the seeded `baseProfile`.【F:apps/platform-api/src/db/seed.ts†L107-L164】【F:apps/platform-api/src/store/organization-members.ts†L22-L59】
- During seeding, `ensureAdminAuthUser` creates or updates a GoTrue user using `PLATFORM_ADMIN_EMAIL`/`PLATFORM_ADMIN_PASSWORD` but does not reconcile the returned `id` or email with `platform.profiles` or `platform.organization_members`.【F:apps/platform-api/src/db/seed.ts†L398-L495】
- Runtime profile queries always return the first row (or the static seed) and never filter by the GoTrue `sub`, so Studio treats every authenticated session as the same platform operator.【F:apps/platform-api/src/store/profile.ts†L8-L20】

## Environment Overrides and Bootstrap Admin
- Environment variables provide defaults for the primary email, username, and admin credentials, but seed logic only inserts the bootstrap profile when it is missing. Changing `PLATFORM_ADMIN_EMAIL` or the Studio defaults after the first run leaves the old values untouched.【F:apps/platform-api/src/config/defaults.ts†L56-L86】【F:apps/platform-api/src/db/seed.ts†L80-L164】
- Password rotation is handled idempotently—`ensureAdminAuthUser` updates the GoTrue password on HTTP 409—but email changes, reused GoTrue accounts, and username overrides are not propagated back into `platform.profiles` or `platform.organization_members` because no update code runs after the initial insert.【F:apps/platform-api/src/db/seed.ts†L398-L495】
- The local state store mirrors the same static profile/org/project defaults in a JSON file, so discrepancies between GoTrue and the platform schema can persist across restarts until a manual cleanup is done.【F:apps/platform-api/src/store/state.ts†L40-L200】

## UI Admin Promotion and Membership Flows
- Studio renders membership data by matching `profile?.gotrue_id` against the `gotrue_id` returned by `/platform/organizations/{slug}/members`. When the bootstrap profile’s UUID diverges from the GoTrue session `sub`, the UI cannot identify "You" or apply role-based affordances.【F:apps/studio/lib/profile.tsx†L33-L107】【F:apps/studio/components/interfaces/Organization/TeamSettings/MemberRow.tsx†L80-L160】
- `useOrganizationMemberAssignRoleMutation` and related hooks call PATCH/DELETE endpoints that do not exist in the platform API, so role changes, owner transfers, and leave-team flows are currently dead ends in the local stack.【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L18-L79】【F:apps/platform-api/src/routes/organizations.ts†L42-L200】
- Permission checks rely entirely on `/platform/profile/permissions`. Because the backend returns wildcard permissions for every organization, Studio either grants everything or—when the fallback member UUID no longer matches the GoTrue `sub`—treats the user as lacking access and shows the "You need additional permissions" banner.【F:apps/studio/data/permissions/permissions-query.ts†L11-L48】【F:apps/platform-api/src/store/permissions.ts†L7-L35】

## Issues Identified
1. **Bootstrap profile never reconciles with GoTrue.** The seeded `baseProfile` uses a random UUID and is only inserted once, so the platform database keeps pointing at a stale `gotrue_id` even after GoTrue creates the real admin account. Subsequent logins present a mismatched `sub`, breaking membership lookups and triggering the permission banner.【F:apps/platform-api/src/config/defaults.ts†L196-L209】【F:apps/platform-api/src/db/seed.ts†L80-L164】
2. **Seed data ignores environment changes.** Updating `PLATFORM_ADMIN_EMAIL`, `STUDIO_DEFAULT_PRIMARY_EMAIL`, or the bootstrap username after the first run has no effect because the seed script never updates existing rows. Operators cannot rotate the root email without manually patching the database.【F:apps/platform-api/src/config/defaults.ts†L56-L86】【F:apps/platform-api/src/db/seed.ts†L80-L164】
3. **Platform API does not authenticate requests.** All `/platform/**` routes run without checking the bearer token or correlating it with `platform.profiles`. As a result, every authenticated caller sees the same profile, organization list, and permissions, and a compromised token could read or mutate global state.【F:apps/platform-api/src/main.ts†L1-L53】【F:apps/platform-api/src/store/profile.ts†L8-L20】
4. **Permissions are over-simplified.** `listPermissions` returns a wildcard grant for every organization regardless of membership, so Studio’s permission checks provide no real isolation. Any discrepancy between the GoTrue session and the bootstrap profile results in false negatives (no access) instead of deriving permissions from `platform.organization_members` and role metadata.【F:apps/platform-api/src/store/permissions.ts†L7-L35】【F:apps/studio/hooks/misc/useCheckPermissions.ts†L137-L190】
5. **Profile creation and membership mutation endpoints are missing.** Studio’s `createProfile` and organization-role mutations target routes that the platform API does not implement. In multi-user scenarios the first login would steal the bootstrap profile and every subsequent user would share it, while admin promotion UIs silently fail.【F:apps/studio/data/profile/profile-create-mutation.ts†L11-L47】【F:apps/platform-api/src/routes/profile.ts†L21-L90】
6. **State duplication obscures the source of truth.** Beyond the database seed, `state.json` rehydrates the same defaults (including the random bootstrap UUID), so even after fixing the database, stale state files can reintroduce mismatches on restart unless the code reconciles against GoTrue on every boot.【F:apps/platform-api/src/store/state.ts†L126-L200】

## Proposed Changes
1. **Reconcile the bootstrap admin with GoTrue.** After `ensureAdminAuthUser` creates or finds the account, fetch the GoTrue user id and email, then upsert `platform.profiles` and `platform.organization_members` with that information. Replace the random UUID in `baseProfile` with the stored value so subsequent restarts stay in sync. Extend the reconciliation to update `primary_email`, `username`, and `auth0_id` when environment overrides change.【F:apps/platform-api/src/db/seed.ts†L398-L495】【F:apps/platform-api/src/config/defaults.ts†L196-L209】
2. **Introduce an authentication guard in the platform API.** Add a Fastify `onRequest` hook (or per-route preHandler) that validates the bearer token with GoTrue, extracts the `sub`, and loads the matching `platform.profiles` row. Cache the lookup in `request.user` so downstream handlers can enforce membership without copying logic into every route.【F:apps/platform-api/src/main.ts†L1-L53】【F:apps/studio/lib/api/apiAuthenticate.ts†L1-L51】
3. **Derive permissions from membership.** Replace the wildcard implementation with a query that joins `platform.organization_members`, organization roles, and project scope for the current profile. This keeps Studio’s permission checks aligned with the database instead of the static seed.【F:apps/platform-api/src/store/permissions.ts†L7-L35】【F:apps/platform-api/src/store/organization-members.ts†L22-L59】
4. **Implement profile lifecycle endpoints.** Add `POST /platform/profile` (and optional PATCH) that create or update a `platform.profiles` row for the current `sub`, populate metadata (email, username), and ensure an owner membership exists for bootstrap scenarios. This lets Studio’s "create profile" fallback succeed for brand-new accounts.【F:apps/studio/data/profile/profile-create-mutation.ts†L11-L47】【F:apps/platform-api/src/routes/profile.ts†L21-L90】
5. **Expose organization membership mutations or adjust the UI.** Either stub the PATCH/DELETE routes Studio expects (updating `organization_members` based on `gotrue_id`) or update the UI to disable those actions in local stacks. Completing the routes keeps the local experience closer to production and exercises the new auth guard.【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L18-L79】【F:apps/platform-api/src/routes/organizations.ts†L42-L200】
6. **Make seeding idempotent and state-aware.** Convert the seed inserts into upserts that refresh key columns when defaults change, and update `state.json` bootstrapping to read the reconciled profile instead of cloning `baseProfile`. Provide a CLI (or startup log) to warn when the bootstrap account cannot be matched to a GoTrue user.【F:apps/platform-api/src/db/seed.ts†L80-L200】【F:apps/platform-api/src/store/state.ts†L126-L200】

### Pros
- Aligns the platform database with the actual GoTrue accounts, eliminating the recurring permission mismatch.
- Restores Studio’s built-in admin promotion flows and makes local testing representative of production behavior.
- Centralizes auth enforcement in one guard, reducing the risk of future routes forgetting to check permissions.

### Cons / Risks
- Additional GoTrue admin API calls on startup add latency and require robust error handling (e.g., when GoTrue is unavailable).
- Updating existing tables in place must be carefully migration-tested to avoid overwriting legitimate multi-user data.
- Implementing full membership mutations increases the surface area of the platform API and needs comprehensive tests to avoid privilege escalation bugs.

## Migration Plan
1. **Schema preparation:** add any necessary indexes/constraints (e.g., unique `primary_email`) and optional columns for tracking last synced GoTrue ids. Provide a one-time SQL migration that backfills `platform.profiles.gotrue_id` by joining on email with `auth.users` where possible.【F:apps/platform-api/migrations/0001_initial.sql†L61-L113】
2. **Bootstrap reconciliation:** update `seedDefaults()` to call a new `syncBootstrapAdmin` helper that retrieves the GoTrue user id, upserts the profile, and refreshes membership/organization ownership before seeding projects.【F:apps/platform-api/src/db/seed.ts†L80-L200】【F:apps/platform-api/src/db/seed.ts†L398-L495】
3. **Auth guard rollout:** introduce the request guard, update routes to use the authenticated profile id instead of `baseProfile`, and adjust tests/fixtures accordingly.【F:apps/platform-api/src/store/organizations.ts†L1-L105】【F:apps/platform-api/src/store/profile.ts†L8-L20】
4. **Permissions overhaul:** replace `listPermissions` and any other permission stubs with membership-aware logic; add unit tests to cover owner, admin, developer, and read-only cases.【F:apps/platform-api/src/store/permissions.ts†L7-L35】
5. **API surface completion:** implement the missing profile and organization member endpoints (or gate the UI) and ensure they respect the new auth guard before exposing them to Studio.【F:apps/platform-api/src/routes/profile.ts†L21-L90】【F:apps/platform-api/src/routes/organizations.ts†L42-L200】
6. **State cleanup:** update `state.ts` to hydrate from the reconciled database profile, and document how to clear stale `state.json` files when migrating existing installations.【F:apps/platform-api/src/store/state.ts†L126-L200】

## Testing Strategy
- **Unit tests:** add coverage for the new auth guard (valid token, invalid token, missing membership) and permission derivation logic across different role assignments.【F:apps/platform-api/src/store/permissions.ts†L7-L35】
- **Integration tests:** exercise the bootstrap reconciliation path against a real GoTrue instance, verifying that changing `PLATFORM_ADMIN_EMAIL` updates both GoTrue and `platform.profiles`, and that Studio can log in without seeing the permission banner.【F:apps/platform-api/src/db/seed.ts†L398-L495】【F:apps/studio/components/layouts/TableEditorLayout/TableEditorLayout.tsx†L1-L25】
- **End-to-end tests:** use the existing Studio onboarding flow to create a new user, confirm that `POST /platform/profile` succeeds, organization membership reflects the new `sub`, and admin promotion flows return 200 responses instead of 404s.【F:apps/studio/data/profile/profile-create-mutation.ts†L11-L47】【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L18-L79】
# Platform Admin Auth & Permissions Investigation

## Current flow

### Studio client ➜ Kong
Supabase Studio authenticates users through GoTrue and exposes helpers to fetch the current JWT (`getAccessToken`) for API calls.【F:apps/studio/lib/gotrue.ts†L1-L37】 Every network request created by `data/fetchers` attaches that bearer token and a request identifier before hitting the API gateway.【F:apps/studio/data/fetchers.ts†L27-L93】 The platform-focused Docker Compose profile points Studio at Kong (`NEXT_PUBLIC_API_URL`, `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_GOTRUE_URL`), so all browser traffic terminates at the gateway.【F:docker/docker-compose.platform.yml†L50-L76】

### Kong ➜ Platform API / PostgREST / GoTrue
The Kong overlay forwards `/api/platform` and `/api/v1` directly to the platform Fastify server with only a CORS plugin, so no gateway-level key or ACL check runs in front of those routes yet.【F:docker/volumes/api/kong.platform.yml†L1-L17】 In contrast, the base declarative config keeps key-auth + ACL plugins in front of `/auth/v1` and `/rest/v1`, meaning any PostgREST query must include both the JWT and the `apikey` header, while GoTrue admin access still requires the service role key.【F:docker/volumes/api/kong.yml†L36-L107】 The `.env.platform` template also instructs PostgREST to expose the `platform` schema alongside the standard schemas, so control-plane tables are reachable from `/rest/v1` once the correct headers are supplied.【F:docker/.env.platform.example†L19-L33】

### Platform API bootstrap
When the platform API starts it runs migrations, seeds defaults, registers `/api/v1` and `/api/platform`, and begins listening.【F:apps/platform-api/src/main.ts†L4-L43】 The seeding routine inserts a base profile, organizations, roles, projects, and project runtimes if they do not yet exist, then grants broad privileges on the `platform` schema and finally ensures the bootstrap admin exists in GoTrue.【F:apps/platform-api/src/db/seed.ts†L77-L399】 Admin creation currently uses the GoTrue admin endpoint to create-or-update the account but stops short of reconciling that account’s UUID back into the control-plane tables.【F:apps/platform-api/src/db/seed.ts†L403-L491】

### Profile, membership, and permissions data
The base profile baked into the configuration has a hard-coded numeric ID of `1` and a randomly generated `gotrue_id` every time the process bootstraps.【F:apps/platform-api/src/config/defaults.ts†L196-L209】 During seeding, the code inserts that profile if missing and creates organization membership rows tied to the same numeric ID.【F:apps/platform-api/src/db/seed.ts†L81-L164】 Subsequent profile reads simply return the first row in the table (or the default struct) without looking at the request’s JWT claims, so every request effectively impersonates that bootstrap record.【F:apps/platform-api/src/store/profile.ts†L8-L10】 The organization member listing joins on `profiles` to expose `gotrue_id`, but falls back to the seeded defaults (and their random UUID) whenever the join fails.【F:apps/platform-api/src/store/organization-members.ts†L20-L53】 Permissions are also stubbed: the API returns a wildcard grant for every organization it finds, regardless of the caller, or reuses the seeded defaults when no rows are present.【F:apps/platform-api/src/store/permissions.ts†L7-L34】

### Studio consumption of control-plane data
Studio reads `/platform/profile` to populate the profile context, then relies on `profile.gotrue_id` to match the current member record when rendering organization settings or permission gates.【F:apps/studio/lib/profile.tsx†L18-L75】【F:apps/studio/components/interfaces/Organization/TeamSettings/LeaveTeamButton.tsx†L21-L72】 Admin actions in the UI call dedicated platform routes such as `PATCH /platform/organizations/{slug}/members/{gotrue_id}` or `DELETE /platform/organizations/{slug}/members/{gotrue_id}` to assign roles or remove members.【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L19-L38】【F:apps/studio/data/organizations/organization-member-delete-mutation.ts†L14-L36】 The server-side `organizations` routes, however, only expose read endpoints for members, roles, and invitations—the write APIs that Studio expects have not been implemented yet.【F:apps/platform-api/src/routes/organizations.ts†L34-L142】

## Source of truth for GoTrue ↔ platform linkage
The only persistent bridge between GoTrue and the control-plane schema today is the `platform.profiles` table seeded from `baseProfile` and the matching entries in `platform.organization_members` (both using ID `1`).【F:apps/platform-api/src/config/defaults.ts†L196-L209】【F:apps/platform-api/src/db/seed.ts†L81-L164】 There is no job or migration that refreshes `gotrue_id`, `primary_email`, or membership metadata after the first insert, and the API never inspects the caller’s JWT to decide which profile to load.【F:apps/platform-api/src/store/profile.ts†L8-L10】 The fallback behavior in `listOrganizationMembers` means the UI will keep seeing the randomly generated `baseProfile.gotrue_id` even after GoTrue assigns a different UUID to the bootstrap admin, breaking any client-side comparison to the session’s subject claim.【F:apps/platform-api/src/store/organization-members.ts†L20-L53】

## Environment override behavior
The platform stack expects maintainers to tweak `.env.platform.example`, then propagate those overrides to `.env` and `docker/.env` via `scripts/platform-stack.sh` before (re)starting the containers.【F:docker/.env.platform.example†L1-L34】【F:scripts/platform-stack.sh†L64-L197】 Those overrides include `PLATFORM_ADMIN_EMAIL` and `PLATFORM_ADMIN_PASSWORD`, but the seeding logic only inserts the base profile when it is missing; changing the admin email after the first boot leaves the original `primary_email`, `username`, and random `gotrue_id` untouched in Postgres even though GoTrue may now have a different account for the bootstrap operator.【F:apps/platform-api/src/db/seed.ts†L81-L164】【F:apps/platform-api/src/db/seed.ts†L403-L445】 Password rotation works because the GoTrue admin endpoint updates it in place, but email rotation or reusing an existing GoTrue account is not idempotent.

## UI-driven admin promotion flows
Studio currently issues member-management requests against platform routes that accept a `{gotrue_id}` path parameter and expect per-member side effects (assignment, unassignment, deletion).【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L19-L38】【F:apps/studio/data/organizations/organization-member-delete-mutation.ts†L14-L36】 The platform API only exposes GET handlers for `/organizations/:slug/members` and related reads, so these write operations either fail or silently no-op today.【F:apps/platform-api/src/routes/organizations.ts†L34-L142】 Because the UI derives the “current member” from `profile.gotrue_id`, the random UUID mismatch also means actions like “Leave team” never match the owner row and therefore stay disabled.【F:apps/studio/components/interfaces/Organization/TeamSettings/LeaveTeamButton.tsx†L41-L80】 No logic depends on hard-coded UUIDs, but cached grants in the UI become useless when the API keeps returning the wrong `gotrue_id`.

## Concrete issues and over-engineering
- **Random bootstrap UUID never reconciled.** `baseProfile.gotrue_id` is generated on every boot and inserted once, so `platform.profiles.gotrue_id` almost never matches the GoTrue account created later.【F:apps/platform-api/src/config/defaults.ts†L196-L209】【F:apps/platform-api/src/db/seed.ts†L81-L164】
- **Seed logic skips updates.** Once the profile row exists, subsequent boots do not refresh `primary_email`, `username`, or `gotrue_id`, leaving stale data after env changes or manual adjustments.【F:apps/platform-api/src/db/seed.ts†L81-L104】
- **GoTrue reconciliation stops at password updates.** `ensureAdminAuthUser` only creates the user or rotates the password; it never pulls the resulting UUID or applies email changes back into Postgres.【F:apps/platform-api/src/db/seed.ts†L403-L491】
- **Request context is ignored.** The API resolves “current profile” by picking the first row in `platform.profiles`, making all requests behave like the bootstrap admin regardless of the caller’s JWT.【F:apps/platform-api/src/store/profile.ts†L8-L10】
- **Fallback member data preserves the wrong UUID.** When the join fails, `listOrganizationMembers` returns the seeded `baseProfile` (and its random `gotrue_id`), so Studio keeps seeing an ID that can never match the GoTrue session.【F:apps/platform-api/src/store/organization-members.ts†L20-L53】
- **Permissions endpoint is a stub.** The `/platform/profile/permissions` handler grants `%` access to every organization, so Studio cannot rely on it for real authorization decisions.【F:apps/platform-api/src/store/permissions.ts†L7-L34】
- **Gateway lacks auth hardening for platform routes.** Kong only enables CORS on `/api/platform`, leaving the control plane effectively unauthenticated at the proxy layer compared to the stricter key-auth on `/auth/v1` and `/rest/v1`.【F:docker/volumes/api/kong.platform.yml†L1-L17】【F:docker/volumes/api/kong.yml†L36-L107】
- **Studio targets unimplemented membership APIs.** Client mutations call `PATCH/DELETE /platform/organizations/{slug}/members/{gotrue_id}` but the Fastify router never defines those endpoints.【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L19-L38】【F:apps/platform-api/src/routes/organizations.ts†L34-L142】

## Proposed comprehensive fix
1. **Deterministic bootstrap profile reconciliation.** After `ensureAdminAuthUser` runs, call the GoTrue admin lookup to retrieve the UUID and email for `PLATFORM_ADMIN_EMAIL`, then `upsert` the `platform.profiles` row (ID `1`) with the latest `gotrue_id`, `primary_email`, names, and username derived from the env vars. If the row already exists, update it instead of skipping. Also ensure `platform.organization_members` keeps a membership for that profile (insert or update) so the owner link is never orphaned.【F:apps/platform-api/src/db/seed.ts†L81-L164】【F:apps/platform-api/src/db/seed.ts†L403-L491】  
   *Pros:* fixes the UUID mismatch, keeps env overrides idempotent, preserves existing membership IDs.  
   *Risks:* needs careful handling when operators intentionally customize profile metadata; should log reconciliation results for transparency.
2. **Align defaults with env overrides.** Default the seeded `primary_email` (and optionally username) to `DEFAULT_ADMIN_EMAIL` so an email override without `STUDIO_DEFAULT_PRIMARY_EMAIL` does not drift. Document that both env vars should be changed together or automatically mirror them when absent.【F:apps/platform-api/src/config/defaults.ts†L56-L209】
3. **Persist admin email changes in GoTrue.** Extend `ensureAdminAuthUser` to detect an existing user with a different email and call the GoTrue admin update endpoint to reconcile email as well as password. Return the UUID for the reconciliation step above, handling 409s and reusing existing accounts gracefully.【F:apps/platform-api/src/db/seed.ts†L403-L491】
4. **Introduce real profile lookup.** Add middleware that validates the bearer token (service key for server-to-server calls, GoTrue JWT for end users), extracts the `sub`, and loads the corresponding profile by `gotrue_id`. Update helpers like `getProfile`, `fetchCurrentProfileId`, and `listPermissions` to respect that context instead of always picking ID `1`.  
   *Pros:* unlocks multi-user scenarios, aligns with Studio’s expectations.  
   *Risks:* requires a consistent way to create profile rows for new users (likely a reconciliation handler behind the profile create mutation).
5. **Backfill membership management routes.** Implement the `PATCH/DELETE /platform/organizations/{slug}/members/{gotrue_id}` handlers (and any associated `POST`) so Studio’s role assignment and leave-team flows succeed. These endpoints should authorize via the decoded profile context and reuse the membership reconciliation logic above.【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L19-L38】【F:apps/platform-api/src/routes/organizations.ts†L34-L142】
6. **Optionally tighten Kong for platform APIs.** Once the Fastify layer validates JWTs, consider mirroring the key-auth/ACL posture at the gateway (or require JWT verification via a dedicated plugin) so unauthenticated callers cannot reach control-plane routes directly.【F:docker/volumes/api/kong.platform.yml†L1-L17】【F:docker/volumes/api/kong.yml†L36-L107】

## Migration plan
1. **Deploy updated seeds.** Ship the reconciliation changes, restart the platform API, and confirm logs report the synced `gotrue_id`. Run the stack with `scripts/platform-stack.sh reset` if you need a clean bootstrap, which re-syncs env files, restarts containers, and reapplies platform grants.【F:scripts/platform-stack.sh†L176-L197】
2. **Backfill existing data.** For already-running stacks, temporarily set `PLATFORM_SKIP_SEQUENCE_RESET=true`, restart the API to run the new reconciliation logic, and verify `platform.profiles.gotrue_id` matches the GoTrue admin UUID via a direct SQL check or `/platform/profile` response.【F:apps/platform-api/src/db/seed.ts†L343-L399】
3. **Validate Studio behavior.** Sign in as the bootstrap admin, ensure `profile.gotrue_id` in the network payload matches the GoTrue token’s `sub`, and confirm organization membership panes no longer show the “additional permissions” banner in table or team settings views.【F:apps/studio/components/interfaces/Organization/TeamSettings/LeaveTeamButton.tsx†L41-L80】
4. **Roll out membership endpoints.** Once the new API handlers land, rerun Studio flows (invite, role update, leave team) to confirm they succeed instead of failing with 404/405 responses.【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L19-L38】【F:apps/platform-api/src/routes/organizations.ts†L34-L142】

## Testing strategy
- **Automated tests:** run `pnpm --filter platform-api test` to exercise the Fastify routes and seeding helpers after adding reconciliation coverage.【F:apps/platform-api/package.json†L7-L19】
- **Integration checks:**
  - Start the stack, sign in via Studio, and verify `/platform/profile` returns the same `gotrue_id` as the GoTrue session (decode JWT or call `/auth/v1/user`).【F:apps/platform-api/src/store/profile.ts†L8-L10】【F:apps/studio/lib/profile.tsx†L18-L75】
  - Hit `/platform/organizations/{slug}/members` and confirm the current user appears with the reconciled UUID and owner flag.【F:apps/platform-api/src/store/organization-members.ts†L20-L53】
  - Exercise membership mutations (assign role, leave team) from the UI once the routes exist to ensure end-to-end persistence works.【F:apps/studio/data/organization-members/organization-member-role-assign-mutation.ts†L19-L38】
- **Gateway sanity:** issue an unauthenticated request to `/api/platform/profile/permissions` and confirm the updated gateway or server logic rejects it once auth enforcement is in place.【F:docker/volumes/api/kong.platform.yml†L1-L17】【F:apps/platform-api/src/store/permissions.ts†L7-L34】

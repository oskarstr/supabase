# Platform Provisioning Contract (WIP)

> Last updated: 2025-10-16 · codex · commit dc6ac32d8e

## Scope
- Covers `createProject`, `deleteProject`, and runtime lifecycle orchestration as implemented in `apps/platform-api/src/store/projects.ts` and the runtime agent (`apps/runtime-agent`).
- Reflects current behaviour under pg-mem/unit tests; end-to-end docker validation is ongoing and additional integration tests are pending.

## Happy Path Flow
1. **Request** – Studio/API calls `POST /api/platform/projects` with `cloud_provider=LOCAL`, `organization_slug`, and database password.
2. **State initialization** – platform-api inserts project row with `status='COMING_UP'` and ensures a runtime directory under `${PLATFORM_PROJECTS_ROOT}/${ref}` via `ensureProjectRuntime`.
3. **Runtime prep** – `prepareSupabaseRuntime` copies the supabase template, allocates per-project ports, and writes `config.toml` plus `.env` seeded with `SUPABASE_DB_PASSWORD/POSTGRES_PASSWORD`.
4. **Orchestrator call** – `provisionProjectStack` POSTs to runtime-agent `/v1/projects/provision` (with bearer token). Payload includes project metadata, runtime root, excluded services, and network id. Agent stops any running stack before re-running `supabase start --ignore-health-check`.
5. **Credential ingest** – After orchestration returns `status='completed'`, platform-api re-reads `.env` for anon/service keys, connection string, REST URL, and Postgres version, persisting them back to Postgres (`projects` table).
6. **Health gating** – `waitForRuntimeHealth` polls REST (`/rest-admin/v1/ready`) and edge functions unless explicitly excluded. On success, project transitions to `ACTIVE_HEALTHY`.

## Failure Handling
- **Provisioner error (runtime-agent 500/timeout)**
  - Project status is set to `INIT_FAILED`.
  - A best-effort `destroyProjectStack` is issued to tear down any partial resources.
  - Error is logged and bubbled to the API response; client should surface failure and allow manual retry.
  - Control plane HTTP calls to the runtime agent respect `PLATFORM_ORCHESTRATOR_TIMEOUT_MS` (default 15 minutes) to avoid wedged lifecycle jobs.
- **Health timeout**
  - After `DEFAULT_TIMEOUT_MS` (10 minutes by default, configurable via `PLATFORM_RUNTIME_HEALTH_TIMEOUT_MS`) if checks never succeed, project status becomes `INIT_FAILED`. Destroy is attempted as above. Excluded services bypass the corresponding checks.
- **Destroy path** (`DELETE /api/platform/projects/:ref`)
  - Status flips to `GOING_DOWN`, runtime-agent `/destroy` executes `supabase stop`, project row is removed, `project_runtimes` entry is deleted, and the runtime directory is removed. Failures during cleanup are logged but do not block the DB delete.
- **Pause/Resume**
  - `pauseProject` sets `PAUSING` → `INACTIVE` (or `PAUSE_FAILED` if runtime-agent stop fails).
  - `resumeProject` reuses `scheduleProvisioning`, meaning the same success/failure semantics apply as new provisioning.

## Data Persistence
- `projects`
  - `status`: lifecycle enum (see `platform.project_status`).
  - `anon_key`, `service_key`, `connection_string`, `rest_url`, `db_version`, `infra_compute_size`, etc.
- `project_runtimes`
  - `root_dir`: absolute path under `${PLATFORM_PROJECTS_ROOT}`.
  - `excluded_services`: text array (requires migrations ≥ `0003_add_project_runtime_settings.sql`).
  - `port_base`: reserved API port anchor; the DB, Studio, and Inbucket ports are derived offsets (`+1`, `+2`, `+3`). Persisting the base prevents port exhaustion as projects churn.
- On-disk runtime
  - `supabase/config.toml`: generated ports/config.
  - `supabase/.env`: runtime credentials persisted back to DB after provisioning.

## Outstanding Gaps / TODO
- Re-run Vitest suite once pg-mem harness applies full migration set; the new lifecycle tests pass, but broader route tests remain disabled after removing the autogenerated suite.
- Add contract tests asserting partial-health scenarios (e.g., REST healthy, Functions excluded) to verify per-service status handling before surfacing to Studio.
- Capture provisioning duration/log metadata in DB for operator visibility.
- Document retry semantics and runtime-agent error payload expectations once streaming/logging stabilises.
- Reintroduce endpoint smoke tests via dedicated workflow once schema migrations can be replayed reliably in githooks/CI.

_This document intentionally focuses on currently implemented behaviour. Update as we integrate additional lifecycle states (RESTORING, RESIZING, etc.) or wire remote cloud providers._
